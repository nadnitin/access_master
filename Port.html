<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RO port</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --brand:#0d6efd;
      --success:#198754;
      --danger:#dc3545;
    }
    body{
      background: linear-gradient(180deg, #f7fbff 0%, #ffffff 100%);
      min-height:100vh;
      padding:1.25rem;
      -webkit-font-smoothing:antialiased;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .card-ghost{
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(6px);
      box-shadow: 0 6px 18px rgba(15,23,42,0.06);
      border: 0;
    }

    /* loader overlay */
    #loaderOverlay{
      position:fixed;
      inset:0;
      z-index:2147483646;
      background: rgba(0,0,0,0.32);
      align-items:center;
      justify-content:center;
      display: none;
      transition: opacity 0.3s ease;
    }

    /* small screens table scroll */
    .table-responsive{ overflow:auto; -webkit-overflow-scrolling:touch; }

    /* compact inputs on mobile */
    @media (max-width:576px){
      .inline-form .form-control { margin-bottom:.5rem; }
      .inline-form .btn { width:100%; margin-bottom:.5rem; }
      .top-actions { gap:.5rem; flex-direction:column; }
    }

    /* compact table rows and columns */
    .table tbody tr td, .table thead tr th {
      vertical-align: middle;
      padding: 0.3rem; /* Reduced padding for smaller row height */
      font-size: 0.85rem; /* Smaller font size for compactness */
    }
    .no-data { opacity:.7; text-align:center; padding:1rem; } /* Reduced padding for no-data message */

    /* searchable input focus */
    #searchBar:focus { box-shadow: 0 0 0 .15rem rgba(13,110,253,0.12); }

    /* sticky header small tweak */
    thead.table-light { position: sticky; top: 0; z-index: 2; }

    /* Page size selector */
    .page-size-selector {
      width: 120px;
    }
  </style>
</head>
<body>

  <div class="container-lg">
    <div class="row justify-content-center">
      <div class="col-12 col-xl-10">

        <div class="card card-ghost mb-4">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
              <div class="d-flex align-items-center gap-3">
                <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#0d6efd,#6c8cff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">RO</div>
                <div>
                  <h4 class="mb-0">port Data Manager</h4>
                  <small class="text-muted">Manage port For RO Connection</small>
                </div>
              </div>

              <div class="d-flex align-items-center gap-2 top-actions">
                <input id="searchBar" class="form-control form-control-sm" style="min-width:220px" placeholder="Search RO Code, RO Name or port">
                <button id="btnRefresh" class="btn btn-outline-secondary btn-sm" title="Refresh list"><i class="bi bi-arrow-clockwise"></i></button>
                <button id="btnOpenAdd" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg"></i> Add</button>
                <div class="btn-group">
                  <button id="btnDownload" class="btn btn-success btn-sm"><i class="bi bi-download"></i> CSV</button>
                  <label class="btn btn-outline-primary btn-sm mb-0" for="csvInput"><i class="bi bi-upload"></i> Import</label>
                  <input id="csvInput" type="file" accept=".csv,text/csv" style="display:none">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- main table card -->
        <div class="card card-ghost">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover table-sm align-middle" id="roTable">
                <thead class="table-light">
                  <tr>
                    <th style="width:15%">RO Code</th>
                    <th style="width:35%">RO Name</th>
                    <th style="width:15%">Port</th>
                    <th style="width:15%">web port</th>
                    <th style="width:20%" class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody id="tableBody">
                  <!-- rows inserted here -->
                </tbody>
              </table>
              <div id="noData" class="no-data">Loading data...</div>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div class="d-flex align-items-center gap-3">
                <small class="text-muted" id="rowsInfo">--</small>
                <!-- Page Size Selector -->
                <select id="pageSizeSelect" class="form-select form-select-sm page-size-selector">
                  <option value="25">25 per page</option>
                  <option value="50">50 per page</option>
                  <option value="100">100 per page</option>
                  <option value="200">200 per page</option>
                  <option value="500">500 per page</option>
                  <option value="1000">1000 per page</option>
                  <option value="2000">2000 per page</option>
                </select>
              </div>
              <nav>
                <ul id="pagination" class="pagination pagination-sm mb-0"></ul>
              </nav>
            </div>
          </div>
        </div>

        <footer class="text-center text-muted mt-3 mb-5">
          <small>For user ssh protocol server</small>
        </footer>

      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form id="editForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Add / Edit RO</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">RO Code</label>
            <input id="m_roCode" required class="form-control" placeholder="e.g. 160487">
          </div>
          <div class="mb-2">
            <label class="form-label">RO Name</label>
            <input id="m_roName" required class="form-control" placeholder="e.g. Mumbai">
          </div>
          <div class="mb-3">
            <label class="form-label">Port</label>
            <input id="m_port" required class="form-control" placeholder="e.g. 5006" list="availableports">
            <!-- Available ports Dropdown -->
            <datalist id="availableports">
              <!-- Available ports will be dynamically added here -->
            </datalist>
            <small class="form-text text-muted">Available ports: 49152-65535 (only unused ports shown)</small>
          </div>
          <div class="mb-3">
            <label class="form-label">web port</label>
            <input id="m_webport" required class="form-control" placeholder="e.g. 5007" list="availableWebports">
            <!-- Available web ports Dropdown -->
            <datalist id="availableWebports">
              <!-- Available web ports will be dynamically added here -->
            </datalist>
            <small class="form-text text-muted">Available web ports: 10001-24000 (only unused ports shown)</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-save2"></i> Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete confirm modal -->
  <div class="modal fade" id="confirmDelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">
          <p class="mb-0"><strong>Are you sure?</strong></p>
          <small class="text-muted">This will permanently delete the selected RO entry.</small>
        </div>
        <div class="modal-footer">
          <button id="delCancel" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="delConfirm" type="button" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:2147483647">
    <div id="liveToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Saved</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- loader overlay -->
  <div id="loaderOverlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Bootstrap 5 JS (bundle includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // ====== CONFIG ======
  const API_URL = 'https://nadnitin.ddns.net/api/data';
  let PAGE_SIZE = 25; // Default page size

  // ====== UI refs ======
  const tableBody = document.getElementById('tableBody');
  const noData = document.getElementById('noData');
  const rowsInfo = document.getElementById('rowsInfo');
  const searchBar = document.getElementById('searchBar');
  const btnRefresh = document.getElementById('btnRefresh');
  const btnOpenAdd = document.getElementById('btnOpenAdd');
  const btnDownload = document.getElementById('btnDownload');
  const csvInput = document.getElementById('csvInput');
  const loaderOverlay = document.getElementById('loaderOverlay');
  const availableports = document.getElementById('availableports');
  const availableWebports = document.getElementById('availableWebports');
  const pageSizeSelect = document.getElementById('pageSizeSelect');

  const editModalEl = document.getElementById('editModal');
  const editModal = new bootstrap.Modal(editModalEl, { backdrop: 'static' });
  const editForm = document.getElementById('editForm');
  const modalTitle = document.getElementById('modalTitle');
  const m_roCode = document.getElementById('m_roCode');
  const m_roName = document.getElementById('m_roName');
  const m_port = document.getElementById('m_port');
  const m_webport = document.getElementById('m_webport');

  const confirmDelModalEl = document.getElementById('confirmDelModal');
  const confirmDelModal = new bootstrap.Modal(confirmDelModalEl);
  const delConfirm = document.getElementById('delConfirm');

  const toastEl = document.getElementById('liveToast');
  const toast = new bootstrap.Toast(toastEl, { delay: 2800 });

  // ====== AVAILABLE PORTS MANAGEMENT ======
  function updateAvailableports() {
    const startPort = 49152;
    const endPort = 65535;
    const usedPorts = new Set();
    allData.forEach(row => {
      const port = parseInt(row.port);
      if (!isNaN(port) && port >= startPort && port <= endPort) {
        usedPorts.add(port);
      }
    });

    availableports.innerHTML = '';
    let addedCount = 0;
    const maxSuggestions = 100;
    for (let port = startPort; port <= endPort && addedCount < maxSuggestions; port++) {
      if (!usedPorts.has(port)) {
        const option = document.createElement('option');
        option.value = port;
        availableports.appendChild(option);
        addedCount++;
      }
    }

    const startWebPort = 10001;
    const endWebPort = 24000;
    const usedWebPorts = new Set();
    allData.forEach(row => {
      const webport = parseInt(row['web_port']);
      if (!isNaN(webport) && webport >= startWebPort && webport <= endWebPort) {
        usedWebPorts.add(webport);
      }
    });

    availableWebports.innerHTML = '';
    let addedWebCount = 0;
    for (let port = startWebPort; port <= endWebPort && addedWebCount < maxSuggestions; port++) {
      if (!usedWebPorts.has(port)) {
        const option = document.createElement('option');
        option.value = port;
        availableWebports.appendChild(option);
        addedWebCount++;
      }
    }
  }

  function getNextAvailablePort() {
    const startPort = 49152;
    const endPort = 65535;
    const usedPorts = new Set();
    allData.forEach(row => {
      const port = parseInt(row.port);
      if (!isNaN(port)) usedPorts.add(port);
    });

    for (let port = startPort; port <= endPort; port++) {
      if (!usedPorts.has(port)) return port;
    }
    return startPort;
  }

  function getNextAvailableWebPort() {
    const startWebPort = 10001;
    const endWebPort = 24000;
    const usedWebPorts = new Set();
    allData.forEach(row => {
      const webport = parseInt(row['web_port']);
      if (!isNaN(webport)) usedWebPorts.add(webport);
    });

    for (let port = startWebPort; port <= endWebPort; port++) {
      if (!usedWebPorts.has(port)) return port;
    }
    return startWebPort;
  }

  // ====== PAGINATION FUNCTIONS ======
  function renderPagination(){
    const total = Math.ceil(filtered.length / PAGE_SIZE) || 1;
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';

    const startLi = document.createElement('li');
    startLi.className = 'page-item ' + (currentPage === 1 ? 'disabled' : '');
    startLi.innerHTML = `<a class="page-link" href="#" title="First page"><i class="bi bi-chevron-double-left"></i></a>`;
    startLi.onclick = (e) => { e.preventDefault(); if(currentPage > 1){ currentPage = 1; render(); } };
    pagination.appendChild(startLi);

    const prevLi = document.createElement('li');
    prevLi.className = 'page-item ' + (currentPage === 1 ? 'disabled' : '');
    prevLi.innerHTML = `<a class="page-link" href="#" title="Previous page"><i class="bi bi-chevron-left"></i></a>`;
    prevLi.onclick = (e) => { e.preventDefault(); if(currentPage > 1){ currentPage--; render(); } };
    pagination.appendChild(prevLi);

    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(total, startPage + 4);

    if (startPage > 1) {
      const firstLi = document.createElement('li');
      firstLi.className = 'page-item';
      firstLi.innerHTML = `<a class="page-link" href="#">1</a>`;
      firstLi.onclick = (e) => { e.preventDefault(); currentPage = 1; render(); };
      pagination.appendChild(firstLi);
      if (startPage > 2) {
        const ellipsisLi = document.createElement('li');
        ellipsisLi.className = 'page-item disabled';
        ellipsisLi.innerHTML = `<a class="page-link" href="#">...</a>`;
        pagination.appendChild(ellipsisLi);
      }
    }

    for (let i = startPage; i <= endPage; i++){
      const li = document.createElement('li');
      li.className = 'page-item ' + (i === currentPage ? 'active' : '');
      li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
      li.onclick = (e) => { e.preventDefault(); currentPage = i; render(); };
      pagination.appendChild(li);
    }

    if (endPage < total) {
      if (endPage < total - 1) {
        const ellipsisLi = document.createElement('li');
        ellipsisLi.className = 'page-item disabled';
        ellipsisLi.innerHTML = `<a class="page-link" href="#">...</a>`;
        pagination.appendChild(ellipsisLi);
      }
      const lastLi = document.createElement('li');
      lastLi.className = 'page-item';
      lastLi.innerHTML = `<a class="page-link" href="#">${total}</a>`;
      lastLi.onclick = (e) => { e.preventDefault(); currentPage = total; render(); };
      pagination.appendChild(lastLi);
    }

    const nextLi = document.createElement('li');
    nextLi.className = 'page-item ' + (currentPage === total ? 'disabled' : '');
    nextLi.innerHTML = `<a class="page-link" href="#" title="Next page"><i class="bi bi-chevron-right"></i></a>`;
    nextLi.onclick = (e) => { e.preventDefault(); if(currentPage < total){ currentPage++; render(); } };
    pagination.appendChild(nextLi);

    const endLi = document.createElement('li');
    endLi.className = 'page-item ' + (currentPage === total ? 'disabled' : '');
    endLi.innerHTML = `<a class="page-link" href="#" title="Last page"><i class="bi bi-chevron-double-right"></i></a>`;
    endLi.onclick = (e) => { e.preventDefault(); if(currentPage < total){ currentPage = total; render(); } };
    pagination.appendChild(endLi);
  }

  // ====== API FUNCTIONS ======
  async function apiFetch(url, options = {}) {
    const fetchOptions = {
      method: options.method || 'GET',
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      }
    };
    if (options.body) fetchOptions.body = JSON.stringify(options.body);

    try {
      const response = await fetch(url, fetchOptions);
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errorText}`);
      }
      try { return await response.json(); } catch { return { message: 'Success' }; }
    } catch (error) {
      console.error('API Fetch Error:', error);
      throw error;
    }
  }

  // ====== UI FUNCTIONS ======
  function showLoader(flag){
    if (!loaderOverlay) return;
    loaderOverlay.style.display = flag ? 'flex' : 'none';
  }

  function showToast(msg, success=true){
    toastEl.classList.remove('text-bg-success','text-bg-danger','text-bg-warning');
    toastEl.classList.add(success ? 'text-bg-success' : 'text-bg-danger');
    document.getElementById('toastBody').textContent = msg;
    toast.show();
  }

  // ====== DATA MANAGEMENT ======
  let allData = [];
  let filtered = [];
  let currentPage = 1;

  async function loadData(){
    showLoader(true);
    if(noData) noData.textContent = 'Loading...';
    try{
      const data = await apiFetch(API_URL);
      allData = data.map(r => ({
        'RO Code': String(r['RO Code'] ?? r.roCode ?? ''),
        'RO Name': String(r['RO Name'] ?? r.roName ?? ''),
        'port': String(r['port'] ?? r.port ?? ''),
        'web_port': String(r['web_port'] ?? '')
      }));
      applyFilter();
      updateAvailableports();
      applyRolePermissions();
    }catch(err){
      console.error('loadData error', err);
      if(noData) noData.textContent = 'Unable to load data.';
      showToast('Failed to fetch data: ' + err.message, false);
    }finally{
      setTimeout(() => showLoader(false), 100);
    }
  }

  function render(){
    const start = (currentPage - 1) * PAGE_SIZE;
    const pageRows = filtered.slice(start, start + PAGE_SIZE);
    tableBody.innerHTML = '';

    if (pageRows.length === 0){
      noData.style.display = 'block';
      noData.textContent = filtered.length === 0 ? 'No entries found.' : 'No entries on this page.';
    } else {
      noData.style.display = 'none';
      for (const row of pageRows){
        const tr = document.createElement('tr');
        const role = localStorage.getItem('role');
        const allowEditDelete = role === 'admin';
        tr.innerHTML = `
          <td class="text-nowrap fw-bold">${escapeHtml(row['RO Code'])}</td>
          <td>${escapeHtml(row['RO Name'])}</td>
          <td class="text-nowrap">${escapeHtml(row['port'])}</td>
          <td class="text-nowrap">${escapeHtml(row['web_port'])}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary me-1" data-code="${escapeAttr(row['RO Code'])}" onclick="openEdit(this)" ${!allowEditDelete?'disabled':''}><i class="bi bi-pencil"></i> Edit</button>
            <button class="btn btn-sm btn-outline-danger" data-code="${escapeAttr(row['RO Code'])}" onclick="confirmDelete(this)" ${!allowEditDelete?'disabled':''}><i class="bi bi-trash"></i> Delete</button>
          </td>`;
        tableBody.appendChild(tr);
      }
    }

    const totalRows = filtered.length;
    const startRow = totalRows === 0 ? 0 : Math.min(totalRows, start + 1);
    const endRow = Math.min(totalRows, start + PAGE_SIZE);
    rowsInfo.textContent = totalRows ? `Showing ${startRow}–${endRow} of ${totalRows} entries (${PAGE_SIZE} per page)` : '0 entries';

    renderPagination();
  }

  function applyFilter(){
    const q = (searchBar.value || '').trim().toLowerCase();
    if (!q) filtered = [...allData];
    else filtered = allData.filter(r =>
      r['RO Code'].toLowerCase().includes(q) ||
      r['RO Name'].toLowerCase().includes(q) ||
      r['port'].toLowerCase().includes(q) ||
      r['web_port'].toLowerCase().includes(q)
    );
    currentPage = 1;
    render();
  }

  pageSizeSelect.addEventListener('change', (e) => {
    PAGE_SIZE = parseInt(e.target.value);
    currentPage = 1;
    render();
  });

  // ====== MODAL & CRUD ======
  btnOpenAdd.addEventListener('click', () => {
    if(localStorage.getItem('role') !== 'admin') return alert('Permission denied');
    modalTitle.textContent = 'Add new RO';
    m_roCode.readOnly = false;
    m_roCode.value = '';
    m_roName.value = '';
    m_port.value = getNextAvailablePort();
    m_webport.value = getNextAvailableWebPort();
    editModal.show();
  });

  window.openEdit = function(btn){
    if(localStorage.getItem('role') !== 'admin') return alert('Permission denied');
    const code = btn.dataset.code;
    const row = allData.find(r => r['RO Code'] === code);
    if (!row) return showToast('Row not found', false);
    modalTitle.textContent = 'Edit RO';
    m_roCode.value = row['RO Code'];
    m_roCode.readOnly = true;
    m_roName.value = row['RO Name'];
    m_port.value = row['port'];
    m_webport.value = row['web_port'];
    editModal.show();
  };

  let toDeleteCode = null;
  window.confirmDelete = function(btn){
    if(localStorage.getItem('role') !== 'admin') return alert('Permission denied');
    toDeleteCode = btn.dataset.code;
    confirmDelModal.show();
  };

  delConfirm.addEventListener('click', async () => {
    if (!toDeleteCode) return;
    confirmDelModal.hide();
    showLoader(true);
    try{
      await apiFetch(`${API_URL}/${encodeURIComponent(toDeleteCode)}`, { method: 'DELETE' });
      showToast('Deleted successfully');
      await loadData();
    }catch(e){
      console.error('Delete error:', e);
      showToast('Delete failed: ' + e.message, false);
    }finally{
      showLoader(false);
      toDeleteCode = null;
    }
  });

  editForm.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    if(localStorage.getItem('role') !== 'admin') return alert('Permission denied');

    const roCode = m_roCode.value.trim();
    const roName = m_roName.value.trim();
    const portVal = m_port.value.trim();
    const webportVal = m_webport.value.trim();
    if (!roCode || !roName) return showToast('RO Code and RO Name are required', false);

    editModal.hide();
    showLoader(true);
    try {
      const data = { 'RO Code': roCode, 'RO Name': roName, 'port': portVal, 'web_port': webportVal };
      if (m_roCode.readOnly) {
        await apiFetch(`${API_URL}/${roCode}`, { method: 'PUT', body: data });
        showToast('Updated successfully');
      } else {
        await apiFetch(API_URL, { method: 'POST', body: data });
        showToast('Added successfully');
      }
      await loadData();
    } catch(err) {
      console.error('Save error:', err);
      showToast('Save failed: ' + err.message, false);
    } finally { showLoader(false); }
  });

  // ====== SEARCH & REFRESH ======
  searchBar.addEventListener('input', applyFilter);
  btnRefresh.addEventListener('click', loadData);

  // ====== DOWNLOAD CSV ======
  btnDownload.addEventListener('click', () => {
    if (!allData.length) return showToast('No data to download', false);
    const header = ['RO Code', 'RO Name', 'port', 'web_port'];
    const rows = allData.map(r => header.map(k => csvSafe(r[k] || '')).join(','));
    const csv = [header.join(','), ...rows].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ro_ports.csv';
    a.click();
    URL.revokeObjectURL(url);
    showToast('CSV downloaded successfully');
  });

  csvInput.addEventListener('change', (e) => {
    if(localStorage.getItem('role') !== 'admin') return alert('Permission denied');
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (event) => {
      const text = event.target.result;
      const lines = text.split(/\r?\n/).filter(line => line.trim());
      if (lines.length < 2) return showToast('CSV file is empty or invalid', false);

      const header = lines[0].split(',').map(h => h.trim().toLowerCase());
      const roCodeIdx = header.findIndex(h => h.includes('ro code'));
      const roNameIdx = header.findIndex(h => h.includes('ro name'));
      const portIdx = header.findIndex(h => h.includes('port'));
      const webportIdx = header.findIndex(h => h.includes('web port') || h.includes('web_port'));
      if (roCodeIdx === -1 || roNameIdx === -1) return showToast('CSV must contain "RO Code" and "RO Name" columns', false);

      showLoader(true);
      let successCount = 0, errorCount = 0;

      try {
        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(',');
          const roCode = (cols[roCodeIdx] || '').trim();
          const roName = (cols[roNameIdx] || '').trim();
          const port = (portIdx >= 0 ? (cols[portIdx] || '').trim() : '');
          const webport = (webportIdx >= 0 ? (cols[webportIdx] || '').trim() : '');
          if (!roCode) continue;
          try {
            await apiFetch(`${API_URL}/${encodeURIComponent(roCode)}`, { method: 'PUT', body: { 'RO Code': roCode, 'RO Name': roName, 'port': port, 'web_port': webport } });
            successCount++;
          } catch { errorCount++; }
        }
        showToast(`CSV import completed: ${successCount} successful, ${errorCount} failed`);
        await loadData();
      } catch(err) { showToast('CSV import failed: ' + err.message, false); }
      finally { showLoader(false); csvInput.value = ''; }
    };
    reader.readAsText(file);
  });

  // ====== HELPERS ======
  function escapeHtml(s) { return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function escapeAttr(s) { return String(s).replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
  function csvSafe(s) { return String(s).includes(',')||String(s).includes('"')?`"${String(s).replaceAll('"','""')}"`:String(s); }

  // ====== ROLE PERMISSIONS ======
  function applyRolePermissions() {
    const role = localStorage.getItem("role");
    const allowEditDelete = role === "admin";

    document.querySelectorAll("button[data-code]").forEach(btn => {
      btn.disabled = !allowEditDelete;
    });

    btnOpenAdd.disabled = !allowEditDelete;
  }

  document.addEventListener("DOMContentLoaded", function () {
    applyRolePermissions();
    const table = document.getElementById("dataTable");
    if (table) {
      const observer = new MutationObserver(applyRolePermissions);
      observer.observe(table, { childList: true, subtree: true });
    }
  });

  // ====== SESSION & AUTH ======
  var nitin = localStorage.getItem("name");
  if (nitin !== "secrate" || localStorage.getItem('name') === 'logout') window.location.href = "index.html";

  var sessionTimeout = setTimeout(logoutUser, 1800000);
  window.addEventListener('mousemove', function () {
    clearTimeout(sessionTimeout);
    sessionTimeout = setTimeout(logoutUser, 1800000);
  });

  function logoutUser() {
    localStorage.setItem("name", "logout");
    localStorage.setItem("state", "");
    localStorage.setItem("role", "");
    localStorage.setItem("username", "");
    localStorage.setItem("account_status", "");
    window.location.href = 'index.html';
  }

  // ====== INIT ======
  loadData();
</script>

</body>
</html>
