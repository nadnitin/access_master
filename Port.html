<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RO Port Manager</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: #f8f9ff;
      min-height: 100vh;
      padding: 20px;
      font-family: Inter;
    }

    .card-ghost {
      background: #fff;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      border: 0;
    }

    #loaderOverlay {
      position: fixed;
      inset: 0;
      z-index: 99999;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .table-sm th,
    .table-sm td {
      padding: 6px;
      font-size: 0.85rem;
    }

    #searchBar:focus {
      box-shadow: 0 0 0 .15rem rgba(13, 110, 253, 0.2);
    }
  </style>
</head>

<body>

  <div class="container-lg">

    <div class="card card-ghost mb-4">
      <div class="card-body d-flex justify-content-between flex-wrap gap-3">
        <div class="d-flex gap-3 align-items-center">
          <div
            style="width:44px;height:44px;background:#0d6efd;color:#fff;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:bold">
            RO</div>
          <div>
            <h4 class="mb-0">RO Port Manager</h4>
            <small class="text-muted">Manage port allocation for RO connections</small>
          </div>
        </div>

        <div class="d-flex gap-2">
          <input id="searchBar" class="form-control form-control-sm" style="min-width:220px"
            placeholder="Search anything...">
          <button class="btn btn-outline-secondary btn-sm" onclick="loadData()"><i
              class="bi bi-arrow-clockwise"></i></button>
          <button class="btn btn-primary btn-sm" id="addBtn" onclick="openAdd()"><i class="bi bi-plus-lg"></i>
            Add</button>
        </div>
      </div>
    </div>

    <div class="card card-ghost">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover table-sm" id="roTable">
            <thead class="table-light">
              <tr>
                <th>RO Code</th>
                <th>RO Name</th>
                <th>Port</th>
                <th>Web Port</th>
                <th>Control Port</th>
                <th>Phase</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
          <div id="noData" class="text-center text-muted py-3">Loading...</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Add/Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <form id="editForm" class="modal-content">
        <div class="modal-header">
          <h5 id="modalTitle">Add / Edit RO</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">RO Code</label>
          <input id="m_roCode" class="form-control mb-2" required>

          <label class="form-label">RO Name</label>
          <input id="m_roName" class="form-control mb-2" required>

          <label class="form-label">Port</label>
          <input id="m_port" class="form-control mb-2" list="fccList" required>
          <datalist id="fccList"></datalist>

          <label class="form-label">Web Port</label>
          <input id="m_webport" class="form-control mb-2" list="webList" required>
          <datalist id="webList"></datalist>

          <label class="form-label">Control Port</label>
          <input id="m_controlport" class="form-control mb-2" list="ctrlList" required>
          <datalist id="ctrlList"></datalist>

          <label class="form-label">Phase</label>
          <select id="m_phase" class="form-control mb-2" required>
            <option value="">Select Phase</option>
            <option value="Phase 7">Phase 7</option>
            <option value="Phase 10">Phase 10</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="loaderOverlay">
    <div class="spinner-border text-primary" style="width:3rem;height:3rem"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API = "http://103.194.228.48:5006";

    const url = new URLSearchParams(location.search);
    const AUTH = {
      username: url.get("u") || "",
      password: url.get("p") || ""
    };

    const isAdmin = (AUTH.username === "nadnitin" || AUTH.username === "emp1");
    let allData = [];
    let filtered = [];
    const editModal = new bootstrap.Modal(document.getElementById("editModal"));


    async function api(url, method = "POST", data = {}) {
      const r = await fetch(API + url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...AUTH, ...data })
      });
      if (!r.ok) throw new Error(r.status);
      return await r.json();
    }

    async function loadData() {
      showLoader(true);
      try {
        const rows = await api("/api/ro/list");
        allData = rows;
        filtered = rows;
        renderTable();   // FIXED
      } catch (e) { console.warn("Failed loading data"); } {
        //alert("Failed loading data");
      }
      showLoader(false);
    }


    // SEARCH FILTER
    document.getElementById("searchBar").addEventListener("input", () => {
      const q = document.getElementById("searchBar").value.toLowerCase();

      filtered = allData.filter(r =>
        r["RO Code"].toLowerCase().includes(q) ||
        r["RO Name"].toLowerCase().includes(q) ||
        (r.port || "").includes(q) ||
        (r.web_port || "").includes(q) ||
        (r.control_port || "").includes(q) ||
        (r.phase || "").toLowerCase().includes(q)
      );

      renderTable();
    });


    // ===============================
    // SUGGESTION PORT LIST LOAD
    // ===============================
    async function loadSuggestions() {
      const data = await api("/api/ro/available-ports");

      fillList("fccList", data.fcc_ports);
      fillList("webList", data.web_ports);
      fillList("ctrlList", data.control_ports);
    }

    function fillList(id, arr) {
      const d = document.getElementById(id);
      d.innerHTML = "";
      arr.forEach(p => {
        const o = document.createElement("option");
        o.value = p;
        d.appendChild(o);
      });
    }


    // ===============================
    // ADD (OPEN MODAL)
    // ===============================
    async function openAdd() {
      document.getElementById("modalTitle").innerText = "Add RO";
      document.getElementById("m_roCode").readOnly = false;

      await loadSuggestions();

      m_roCode.value = "";
      m_roName.value = "";
      m_port.value = "";
      m_webport.value = "";
      m_controlport.value = "";
      m_phase.value = "";

      editModal.show();
    }


    // ===============================
    // EDIT (OPEN MODAL)
    // ===============================
    async function openEdit(code) {

      const r = allData.find(x => x["RO Code"] === code);
      if (!r) return;

      document.getElementById("modalTitle").innerText = "Edit RO";
      document.getElementById("m_roCode").readOnly = true;

      await loadSuggestions();

      m_roCode.value = r["RO Code"];
      m_roName.value = r["RO Name"];
      m_port.value = r.port;
      m_webport.value = r.web_port;
      m_controlport.value = r.control_port;
      m_phase.value = r.phase;

      editModal.show();
    }


    // ===============================
    // SAVE (ADD / UPDATE)
    // ===============================
    document.getElementById("editForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      showLoader(true);

      const payload = {
        "RO Code": m_roCode.value,
        "RO Name": m_roName.value,
        "port": m_port.value,
        "web_port": m_webport.value,
        "control_port": m_controlport.value,
        "phase": m_phase.value
      };

      try {
        if (document.getElementById("m_roCode").readOnly) {
          // UPDATE
          await api(`/api/ro/update/${m_roCode.value}`, "PUT", payload);
        } else {
          // ADD
          await api("/api/ro/add", "POST", payload);
        }

        loadData();
        editModal.hide();

      } catch (e) { console.warn("Failed loading data"); } {
        console.warn("Error saving");

      }

      showLoader(false);
    });


    // ===============================
    // DELETE
    // ===============================
    async function openDelete(code) {
      if (!confirm("Delete this RO?")) return;

      showLoader(true);

      try {
        await api(`/api/ro/delete/${code}`, "DELETE");
        loadData();
      } catch (e) { console.warn("Failed loading data"); } {
        console.warn("Delete failed");

      }

      showLoader(false);
    }


    // ===============================
    // LOADER CONTROL
    // ===============================
    function showLoader(state) {
      document.getElementById("loaderOverlay").style.display = state ? "flex" : "none";
    }


    // ===============================
    // RENDER TABLE
    // ===============================
    function renderTable() {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      filtered.forEach(r => {

        const allowEdit = (AUTH.username === "nadnitin" || AUTH.username === "emp1");

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${r["RO Code"]}</td>
            <td>${r["RO Name"]}</td>
            <td>${r.port}</td>
            <td>${r.web_port}</td>
            <td>${r.control_port}</td>
            <td>${r.phase}</td>
            <td class="text-end">
                <button class="btn btn-sm btn-outline-primary me-1" 
                    onclick="openEdit('${r["RO Code"]}')"
                    ${!allowEdit ? "disabled style='opacity:0.4;pointer-events:none'" : ""}>
                    Edit
                </button>

                <button class="btn btn-sm btn-outline-danger"
                    onclick="openDelete('${r["RO Code"]}')"
                    ${!allowEdit ? "disabled style='opacity:0.4;pointer-events:none'" : ""}>
                    Delete
                </button>
            </td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("noData").style.display = filtered.length ? "none" : "block";
    }

    window.onload = () => {
      if (!isAdmin) document.getElementById("addBtn").style.display = "none";

      if (!AUTH.username || !AUTH.password) {
        alert("Authentication missing in URL!");
        return;
      }

      loadData();
    };


  </script>
</body>

</html>
